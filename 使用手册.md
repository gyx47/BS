# 图片管理系统 - Docker部署使用手册

## 目录
1. [系统简介](#系统简介)
2. [环境要求](#环境要求)
3. [快速开始](#快速开始)
4. [详细配置](#详细配置)
5. [功能使用指南](#功能使用指南)
6. [常见问题](#常见问题)
7. [维护与更新](#维护与更新)

---

## 系统简介

图片管理系统是一个基于React和Flask的现代化图片管理平台，支持图片上传、存储、编辑、AI分析和智能搜索功能。

### 主要功能
- ✅ 用户注册、登录认证
- ✅ 图片上传（支持拖拽上传，多种格式）
- ✅ EXIF信息自动提取（时间、地点、相机信息等）
- ✅ 自定义标签系统
- ✅ 缩略图自动生成
- ✅ 多条件搜索和筛选
- ✅ 图片编辑功能（裁剪、色调调整、旋转、翻转）
- ✅ AI图片内容分析（对象识别、场景分类、颜色分析）
- ✅ 图片轮播播放
- ✅ 响应式设计，支持移动端

---

## 环境要求

### 必需软件
- **Docker** 版本 20.10 或更高
- **Docker Compose** 版本 1.29 或更高
- 至少 **2GB** 可用内存
- 至少 **10GB** 可用磁盘空间

### 系统要求
- Linux、macOS 或 Windows（支持WSL2）
- 网络连接（用于下载Docker镜像和AI服务）

### 验证安装
```bash
# 检查Docker版本
docker --version

# 检查Docker Compose版本
docker-compose --version
```

---

## 快速开始

### 1. 获取项目代码

```bash
# 克隆或下载项目到本地
cd /path/to/project
```

### 2. 配置环境变量

```bash
# 复制环境变量示例文件
cp env.example .env

# 编辑.env文件，根据需要修改配置
# 至少需要设置数据库密码
nano .env  # 或使用其他编辑器
```

**最小配置示例：**
```env
DB_PASSWORD=your_secure_password
DB_ROOT_PASSWORD=your_root_password
```

### 3. 启动服务

```bash
# 使用Docker Compose启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

### 4. 访问系统

- **前端界面**: http://localhost:3000
- **后端API**: http://localhost:5000
- **MySQL数据库**: localhost:3306

### 5. 停止服务

```bash
# 停止所有服务
docker-compose down

# 停止并删除数据卷（注意：会删除所有数据）
docker-compose down -v
```

---

## 详细配置

### 环境变量说明

编辑 `.env` 文件以配置系统：

#### 数据库配置
```env
DB_HOST=mysql              # 数据库主机（容器内使用mysql）
DB_PORT=3306              # 数据库端口
DB_USER=photo             # 数据库用户名
DB_PASSWORD=photo         # 数据库密码（请修改为强密码）
DB_NAME=photo_management  # 数据库名称
DB_ROOT_PASSWORD=rootpassword  # MySQL root密码（请修改）
```

#### 服务端口配置
```env
BACKEND_PORT=5000   # 后端服务端口
FRONTEND_PORT=3000  # 前端服务端口
```

#### AI服务配置（可选）
```env
# 选择AI服务提供商
AI_PROVIDER=fallback  # 可选: zhipu, openai, deepseek, gemini, google, local, fallback

# 智谱AI
ZHIPU_API_KEY=your_zhipu_api_key

# OpenAI
OPENAI_API_KEY=your_openai_api_key

# DeepSeek
DEEPSEEK_API_KEY=your_deepseek_api_key

# Google Gemini
GEMINI_API_KEY=your_gemini_api_key

# Google Cloud Vision
GOOGLE_API_KEY=your_google_api_key
```

### Docker Compose服务说明

#### MySQL服务
- **镜像**: mysql:8.0
- **数据持久化**: `mysql_data` 卷
- **自动初始化**: 自动执行 `database_schema.sql`

#### 后端服务
- **构建**: 基于 `Dockerfile.backend`
- **依赖**: 等待MySQL健康检查通过后启动
- **数据卷**: 
  - `./uploads` - 上传的图片
  - `./thumbnails` - 生成的缩略图
  - `./logs` - 日志文件

#### 前端服务
- **构建**: 基于 `Dockerfile.frontend`（多阶段构建）
- **Web服务器**: Nginx
- **API代理**: 自动代理 `/api` 请求到后端

### 数据持久化

系统使用Docker卷来持久化数据：

```bash
# 查看数据卷
docker volume ls

# 备份MySQL数据
docker exec photo_mysql mysqldump -u root -p photo_management > backup.sql

# 恢复MySQL数据
docker exec -i photo_mysql mysql -u root -p photo_management < backup.sql

# 备份上传的图片
tar -czf uploads_backup.tar.gz uploads/ thumbnails/
```

---

## 功能使用指南

### 1. 用户注册与登录

1. 访问 http://localhost:3000
2. 点击"注册"按钮
3. 填写用户名（至少6个字符）、邮箱、密码（至少6个字符）
4. 点击"注册"完成注册
5. 使用注册的用户名和密码登录

### 2. 上传图片

1. 登录后，点击"上传"按钮或导航到上传页面
2. 拖拽图片到上传区域，或点击选择文件
3. 支持格式：PNG, JPG, JPEG, GIF, BMP, TIFF, WEBP
4. 上传后系统会自动：
   - 提取EXIF信息（拍摄时间、相机信息、地理位置等）
   - 生成缩略图
   - 执行AI分析（如果配置了AI服务）
   - 添加自动标签

### 3. 浏览和管理图片

1. 在"图库"页面查看所有图片
2. 使用搜索框按文件名或地点搜索
3. 使用标签筛选器按标签筛选
4. 使用日期范围选择器按拍摄时间筛选
5. 点击图片查看详情

### 4. 图片编辑

1. 在图片详情页点击"编辑"按钮
2. 可进行以下操作：
   - **裁剪**: 选择区域并裁剪
   - **旋转**: 顺时针/逆时针旋转
   - **翻转**: 水平或垂直翻转
   - **色调调整**: 调整亮度、对比度、饱和度、色相
3. 点击"保存"应用更改

### 5. 标签管理

1. **自动标签**: 系统根据EXIF信息和AI分析自动生成
2. **自定义标签**: 
   - 在图片详情页添加自定义标签
   - 多个标签用逗号分隔
3. **标签筛选**: 在图库页面使用标签筛选器

### 6. AI分析

1. 在图片详情页点击"AI分析"按钮
2. 系统会调用配置的AI服务分析图片内容
3. 分析结果包括：
   - 场景类型（风景、城市、人物等）
   - 主要对象
   - 颜色特征
   - 情绪氛围
4. 分析结果会自动添加为标签

### 7. 图片轮播

1. 在图库页面选择多张图片
2. 点击"轮播"按钮
3. 全屏查看图片轮播

---

## 常见问题

### Q1: 容器启动失败，提示端口被占用

**解决方案：**
```bash
# 修改.env文件中的端口配置
BACKEND_PORT=5001
FRONTEND_PORT=3001

# 或停止占用端口的服务
# Windows
netstat -ano | findstr :5000
taskkill /PID <PID> /F

# Linux/macOS
lsof -i :5000
kill -9 <PID>
```

### Q2: 数据库连接失败

**解决方案：**
```bash
# 检查MySQL容器是否运行
docker-compose ps

# 查看MySQL日志
docker-compose logs mysql

# 重启MySQL服务
docker-compose restart mysql

# 检查数据库配置
docker exec photo_mysql mysql -u root -p -e "SHOW DATABASES;"
```

### Q3: 前端无法访问后端API

**解决方案：**
```bash
# 检查nginx配置
docker exec photo_frontend cat /etc/nginx/conf.d/default.conf

# 检查后端服务是否运行
docker-compose logs backend

# 重启服务
docker-compose restart frontend backend
```

### Q4: 上传的图片无法显示

**解决方案：**
```bash
# 检查上传目录权限
ls -la uploads/ thumbnails/

# 检查Docker卷挂载
docker-compose exec backend ls -la /app/uploads

# 重新创建目录
mkdir -p uploads thumbnails
chmod 755 uploads thumbnails
```

### Q5: AI分析功能不工作

**解决方案：**
1. 检查 `.env` 文件中的AI配置
2. 确认API密钥是否正确
3. 查看后端日志：
   ```bash
   docker-compose logs backend | grep -i ai
   ```
4. 如果使用fallback模式，AI分析会使用基础算法

### Q6: 如何重置数据库

**解决方案：**
```bash
# 停止服务
docker-compose down

# 删除数据卷
docker volume rm bs_mysql_data

# 重新启动
docker-compose up -d
```

### Q7: 如何更新系统

**解决方案：**
```bash
# 拉取最新代码
git pull

# 重新构建镜像
docker-compose build

# 重启服务
docker-compose up -d
```

### Q8: 性能优化建议

1. **数据库优化**:
   ```bash
   # 调整MySQL配置
   # 编辑 mysql_conf/my.cnf
   ```

2. **图片存储**:
   - 考虑使用对象存储（如S3、OSS）替代本地存储
   - 定期清理不需要的图片

3. **缓存配置**:
   - 前端已配置静态资源缓存
   - 可添加Redis缓存层

---

## 维护与更新

### 日常维护

#### 查看日志
```bash
# 查看所有服务日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f backend
docker-compose logs -f frontend
docker-compose logs -f mysql
```

#### 备份数据
```bash
# 创建备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
docker exec photo_mysql mysqldump -u root -p${DB_ROOT_PASSWORD} photo_management > backup_${DATE}.sql
tar -czf uploads_backup_${DATE}.tar.gz uploads/ thumbnails/
```

#### 监控资源使用
```bash
# 查看容器资源使用
docker stats

# 查看磁盘使用
docker system df
```

### 系统更新

```bash
# 1. 备份数据
# 2. 停止服务
docker-compose down

# 3. 拉取最新代码
git pull

# 4. 重新构建镜像
docker-compose build --no-cache

# 5. 启动服务
docker-compose up -d

# 6. 检查服务状态
docker-compose ps
docker-compose logs -f
```

### 故障排查

1. **检查容器状态**: `docker-compose ps`
2. **查看日志**: `docker-compose logs`
3. **检查网络**: `docker network ls`
4. **检查卷**: `docker volume ls`
5. **重启服务**: `docker-compose restart`

---

## 技术支持

如遇到问题，请：
1. 查看日志文件
2. 检查环境变量配置
3. 参考本文档的常见问题部分
4. 提交Issue到项目仓库

---

**版本**: 1.0.0  
**最后更新**: 2024年

